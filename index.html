<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width">
<title>PAGE1</title>
<link rel="stylesheet" type="text/css" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">

<link rel='stylesheet prefetch' href='css/animate.min.css'>
<link rel="stylesheet" type="text/css" href="css/spindefault.css">
<link rel="stylesheet" type="text/css" href="css/stylespage1.css">


<link rel="stylesheet" type="text/css" href="font/titillium/stylesheet.css">
<link rel="stylesheet" type="text/css" href="font/exo-demibold/stylesheet.css">
<link rel="stylesheet" type="text/css" href="css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="css/resetpage1.css">
<link rel="stylesheet" type="text/css" href="css/animation.css">
<link rel="stylesheet" type="text/css" href="css/blue/responsive.css">
<link rel="stylesheet" type="text/css" href="css/blue/color.css">

<link rel="stylesheet" type="text/css" href="css/live-preview.css">
<link rel="stylesheet" type="text/css" href="live-font/stylesheet.css">

<script type="text/javascript" src="js/modernizr.custom.29473.js"></script>
<script type="text/javascript" src="js/jquery-1.12.0.min.js"></script>
<script src="http://openlayers.org/en/v3.16.0/build/ol.js"></script>

<script type="text/javascript" src="js/dropdown.js"></script>
<!-- 以上是页面部分引用的包 -->
<link rel="stylesheet" href="assets/ol3/css/ol.css" type="text/css">
<script src="assets/js/helpers.js"></script>


<script src='https://rawgit.com/Turfjs/turf/v2.0.2/turf.min.js'></script>
  <script src="assets/js/es6-promise.min.js"></script>
  <script src="assets/js/fetch.js"></script>
  <script src="assets/js/tspant.js"></script>
  <!-- 打印地图 -->
  <script type="text/javascript" src="js/FileSaver.js"></script>
  <script type="text/javascript" src="js/canvas-toBlob.js"></script>
<style>
.Detail
{
    border-right: #7b9ebd 1px solid;
    padding-right: 2px;
    border-top: #7b9ebd 1px solid;
    padding-left: 2px;
    font-size: 12px;
    FILTER: progid:DXImageTransform.Microsoft.Gradient(GradientType=0,  StartColorStr=#ffffff,  EndColorStr=#cecfde);
    border-left: #7b9ebd 1px solid;
    cursor: hand;
    color: black;
    padding-top: 2px;
    border-bottom: #7b9ebd 1px solid;
}
      .ol-popup {
        position: absolute;
        background-color: white;
        -webkit-filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
        filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #cccccc;
        bottom: 12px;
        left: -50px;
        min-width: 280px;
      }
      .ol-popup:after, .ol-popup:before {
        top: 100%;
        border: solid transparent;
        content: " ";
        height: 0;
        width: 0;
        position: absolute;
        pointer-events: none;
      }
      .ol-popup:after {
        border-top-color: white;
        border-width: 10px;
        left: 48px;
        margin-left: -10px;
      }
      .ol-popup:before {
        border-top-color: #cccccc;
        border-width: 11px;
        left: 48px;
        margin-left: -11px;
      }
      .ol-popup-closer {
        text-decoration: none;
        position: absolute;
        top: 2px;
        right: 8px;
      }
      .ol-popup-closer:after {
        content: "✖";
      }
    </style>
      <style type="text/css">
      html,body{
        width: 100%;
        height:100%;
      }
    </style>
</head>
<body>
<!-- Live Preview -->
<ul class="nav" style="position:fixed;">
  
  <!-- Start Home -->
  <li id="first">
    <div id="cover1"><a href="3d/buildingsdemo.html" >三维校园<i class="icon-chevron-down"></i></a></div>
    <div id="icon"><i class="icon-home" ></i></div>
     <ul class="one" id="home">
     	<li>
        	<h3><i class="icon-user"></i>Welcome</h3>
            <p id="p-first">中国地质大学（武汉）位于武汉东湖国家自主创新示范区腹地。学校拥有国家4A级旅游景区——逸夫博物馆，是全国文明单位、湖北省最佳文明单位。校园环境优美，教育、科研、学术氛围浓厚，拥有现代化的教学楼群、图书馆、学生公寓和近万台随时上网的计算机等相关配套设施，为莘莘学子提供了良好的学习、生活和成长的环境。</p>
            <a href="http://www.cug.edu.cn/new/">中国地质大学</a>
        </li>
     </ul>
  </li>
  
  <!-- Start Portfolio -->
  <li>
    <div id="cover1"><a href="clustertest.html">报修管理<i class="icon-chevron-down"></i></a></div>
    <div id="icon"><i class="icon-briefcase" ></i></div>
  </li>
  
  <!-- Start Services -->
  <li>
    <div id="cover1"><a href="TSP.html">路径导航<i class="icon-chevron-down"></i></a></div>
    <div id="icon"><i class="icon-truck" ></i></div>
  </li>
 
  <li>
    <div id="cover1"><a href="heatmap.html">垃圾箱管理<i class="icon-chevron-down"></i></a></div>
    <div id="icon"><i class="icon-book" ></i></div>
    <ul class="one" id="about">
      <li><img src="img/thumb1.png" alt="image">
        <h3><i class="icon-user"></i>模型简介及参数说明</h3>
        <p>
        道路理论垃圾桶数量 =<br>（人均垃圾量*一天总的道路人流量）/（容量*清理次数）<br><br>
若理论数量>实际数量,增加垃圾桶数量或增加清理次数<br>若理论数量>实际数量,减少垃圾桶数量或保持现状<br><br>
您可以通过重新设定清理次数或垃圾桶个数来计算上述比值得出优化配置结果（增加几个，在哪个位置合适，垃圾桶数量过多会影响美观性,这时您可以考虑增加清理次数来代替增加数量）
        </p>
        <h6><i class="icon-quote-left"></i>垃圾也有用，请别乱扔它。<i class="icon-quote-right"></i></h6>
      </li>
    </ul>
  </li>
  
  <!-- Start Contact -->
  <li>
    <div id="cover1"><a href="joins-inside.html">失物招领<i class="icon-chevron-down"></i></a></div>
    <div id="icon"><i class="icon-envelope" ></i></div>
    <ul class="one" id="contact">
      <li id="part-right">
        <p>地点<em>*</em></p>
        <input name="name" type="text" id="name">
        <p>联系方式<em>*</em></p>
        <input name="email" type="text" id="email">
        <p>描述<em>*</em></p>
        <textarea name="comment" cols="" rows="" id="comment"></textarea>
        <p>请在地图上添加物品丢失的位置<em>*</em></p>
      </li>
    </ul>
  </li>
  
  <!-- Start Search -->

  
</ul>

<div id="map" class="map" style="width:100%;height:100%;"></div>
  <div id="popup" class="ol-popup">
      <a href="#" id="popup-closer" class="ol-popup-closer"></a>
      <div id="popup-content">
      </div>
  </div>

  <!-- 右下角工具栏 -->
<div class="htmleaf-container">
  <div id='ss_menu'>
    <div>

    <i class="fa fa-print" id="printmap" onclick="printmapfun()"><a id="export-png" class="btn btn-default" download="map.png"></a></i>
    </div>
    <div>
    <i class="fa fa-arrows-h" id="measurelength" onclick="measurelengthfun()" data-toggle="false"></i>
    </div>
    <div>
    <i class="fa fa-lemon-o" id="measurearea" onclick="measureareafun()" data-toggle="false"></i>
    </div>
    <div>
    <i class="fa fa-globe" id="globemap" onclick="globemapfun()"></i>
    </div>
    <div class='menu'>
    <div class='share ' id='ss_toggle' data-rot='180'>
      <div class='circle'></div>
      <div class='bar'></div>
    </div>
    </div>
  </div>
</div>
<script>
$(document).ready(function (ev) {
  var toggle = $('#ss_toggle');
  var menu = $('#ss_menu');
  var rot;
  $('#ss_toggle').on('click', function (ev) {
    rot = parseInt($(this).data('rot')) - 180;
    menu.css('transform', 'rotate(' + rot + 'deg)');
    menu.css('webkitTransform', 'rotate(' + rot + 'deg)');
    if (rot / 180 % 2 == 0) {
      toggle.parent().addClass('ss_active');
      toggle.addClass('close');
    } else {
      toggle.parent().removeClass('ss_active');
      toggle.removeClass('close');
    }
    $(this).data('rot', rot);
  });
  menu.on('transitionend webkitTransitionEnd oTransitionEnd', function () {
    if (rot / 180 % 2 == 0) {
      $('#ss_menu div i').addClass('ss_animate');
    } else {
      $('#ss_menu div i').removeClass('ss_animate');
    }
  });
});
</script>
  <script>
//构造弹框的函数
      var container = document.getElementById('popup');
      var content = document.getElementById('popup-content');
      var closer = document.getElementById('popup-closer');
/**
       * 创建覆盖来固定弹出框
       */
      var overlay = new ol.Overlay(/** @type {olx.OverlayOptions} */ ({
        element: container,
        autoPan: true,
        autoPanAnimation: {
          duration: 250
        }
      }));
/**
       * 添加关闭时的函数
       */
      closer.onclick = function() {
        overlay.setPosition(undefined);
        closer.blur();
        return false;
        clearmeasure();
      };



   // Open Street Map 地图层，用于显示瓦片格式，并由特定分辨率的缩放级别组织的瓦片网格构成
    var openStreetMapLayer = new ol.layer.Tile({
        source:new ol.source.OSM()
    });

    var vector_region = new ol.layer.Vector({
        source: new ol.source.Vector({
          url: 'data/kml/basemap_area.kml',
          format: new ol.format.KML()
        })
      });
     var vector_line = new ol.layer.Vector({
        source: new ol.source.Vector({
          url: 'data/kml/basemap_line.kml',
          format: new ol.format.KML()
        })
      });

//面的样式
var polygonStyle = new ol.style.Style({
  fill: new ol.style.Fill({ //矢量图层填充颜色，以及透明度
    color: 'rgba(255, 255, 255, 0.5)'
  }),
  stroke: new ol.style.Stroke({ //边界样式
    color: '#319FD3',
    width: 2
  })
});
     console.log(polygonStyle);

     var geoJSON_region = new ol.layer.Vector({
        source: new ol.source.Vector({
          url: 'data/json/basemaplast_json.geojson',
          // url: 'data/json/basemap2geojsonutf8.json',
          format: new ol.format.GeoJSON()
        }),
        style: polygonStyle

      });
     console.log(geoJSON_region);
     console.log(vector_region);
    var mapCenter=ol.proj.fromLonLat([114.3983815703, 30.5256872217]);
    var mapcenter=[114.3983815703, 30.5256872217];
    var projection = ol.proj.get('EPSG:3857');
    var view1 = new ol.View({
        // the view's initial state
        center:ol.proj.transform(mapcenter, 'EPSG:4326', 'EPSG:3857'),
        zoom: 15
      });


//定义OL地图
    var map=new ol.Map({
     target: 'map',//定义显示容器
      // layers:[openStreetMapLayer,geoJSON_region],//按顺序添加图层
      layers:[geoJSON_region,openStreetMapLayer],//按顺序添加图层
      controls: ol.control.defaults().extend([
          new ol.control.OverviewMap()
        ]),
     overlays: [overlay],
      //       // 设置地大为地图中心,openlayers需要知道所使用的数据的坐标系（openstreetmap采用栅格瓦片地图采用球面墨卡托投影，所以采用墨卡托坐标设置初始化时的中心点，通过transform方法将容易获取的地理坐标系转换为墨卡托坐标系）
      //       center:ol.proj.transform(mapCenter, 'EPSG:4326', 'EPSG:3857'),
      //       zoom: 15
 
      view:view1
    });

function mapclick(evt)
{
   clearmeasure();
  var pixel = map.getEventPixel(evt.originalEvent);
  var feature = map.forEachFeatureAtPixel(pixel, function(feature, layer) {
    console.log(feature);
    return feature;
  });
  var coordinate = evt.coordinate;
  var hdms = ol.coordinate.toStringHDMS(ol.proj.transform(
      coordinate, 'EPSG:3857', 'EPSG:4326'));
  if(feature!==undefined){
      content.innerHTML = '<p>你点击的坐标是：</p><code>' + hdms + '</code><p>这里属于：'+ feature.get('name') + '</p>'+
      ' <a id="Detail"  href=Indoor.html?abc='+ feature.get('building_i') + '>查看详情</a>'+' <a id="Detail"  href=create.html?abc='+ feature.get('building_i') + '>创建路网数据</a>';
  }
  else{
      content.innerHTML = '<p>你点击的坐标是：</p><code>' + hdms + '</code><p>这里尚未统计在房产系统中！</p>';
  }
  overlay.setPosition(coordinate);
  map.addOverlay(overlay);
}

/** * 鼠标点击的事件 */
map.on('click', mapclick);
  var geojsonObject = {
        "type": "FeatureCollection",
        "features": [{
            "type": "Feature",
            "properties": {},
            "geometry": {
                "type": "Point",
                "coordinates": [114.39778640000009, 30.522237200000063]
            }
        }]
    };
    var vectorSourceDrawLine = new ol.source.Vector({
        features: (new ol.format.GeoJSON()).readFeatures(geojsonObject)
    });
     var vectorSourceDrawReg = new ol.source.Vector({
        features: (new ol.format.GeoJSON()).readFeatures(geojsonObject)
    });
      vectorSourceDrawLine.clear();
      vectorSourceDrawReg.clear();
//申明一个变量用来保存要绘制的线
  // var vectorSourceDrawLine = new ol.source.GeoJSON();
  var vectorLayerDrawLine = new ol.layer.Vector({
    source:vectorSourceDrawLine
  });
  //申明一个变量用来保存要绘制的线
  // var vectorSourceDrawReg = new ol.source.GeoJSON();
  var vectorLayerDrawReg= new ol.layer.Vector({
    source:vectorSourceDrawReg
  });
var drawLine;
var drawReg;
function clearmeasure(){
      map.removeInteraction(drawReg);
      map.removeInteraction(drawLine);
      vectorSourceDrawLine.clear();
      vectorSourceDrawReg.clear();
      // map.on(mapclick);

}
function globemapfun(e)   //回到初始位置
{
  console.log("全图显示");
  var duration = 2000;
      var start = +new Date();
      var pan = ol.animation.pan({
        duration: duration,
        source: /** @type {ol.Coordinate} */ (view1.getCenter()),
        start: start
      });
      var bounce = ol.animation.bounce({
        duration: duration,
        resolution: 4 * view1.getResolution(),
        start: start
      });
      map.beforeRender(pan, bounce);
      view1.setCenter(mapCenter);
      view1.setZoom(15);
}
function measureareafun()//测距离
{
  console.log("侧面积");
  map.un('click',mapclick);
  map.removeInteraction(drawLine);
      var toggleState = document.getElementById("measurearea").getAttribute('data-toggle');
      if(toggleState==='true')
      {
         document.getElementById("measurearea").setAttribute('data-toggle','false');
        map.removeInteraction(drawReg);
      }
      else{
         document.getElementById("measurearea").setAttribute('data-toggle','true');
        drawReg= new ol.interaction.Draw({
          source:vectorSourceDrawReg,
          type:'Polygon'
        });
        drawReg.on('drawend',function(e){
      //移除之前的面要素
      // vectorSourceDrawLine.clear();
      // vectorSourceDrawReg.clear();
      var formatDrawReg=new ol.format.GeoJSON();
      featureDrawReg= formatDrawReg.writeFeature(e.feature.clone(),{
        dataProjection:'EPSG:4326',
        featureProjection:'EPSG:3857'
      });
      vectorSourceDrawReg.addFeature(e.feature);
      console.log(featureDrawReg);
      var featureDrawRegobject;
      eval("featureDrawRegobject="+featureDrawReg); 
      var area1=turf.area(featureDrawRegobject);
      alert("area :  "+area1);
      clearmeasure();
      map.on('click',mapclick);
    });
        //向地图添加交互
        map.addInteraction(drawReg);
      }
}
function measurelengthfun(e) //测面积
{
  console.log("测距离");
  map.un('click',mapclick);     //移除原先鼠标点击事件
  map.removeInteraction(drawReg);
      var toggleState =document.getElementById("measurelength").getAttribute('data-toggle');
      if(toggleState==='true')
      {
        document.getElementById("measurelength").setAttribute('data-toggle','false');
        map.removeInteraction(drawLine);
      }
      else{
        document.getElementById("measurelength").setAttribute('data-toggle','true');
        drawLine= new ol.interaction.Draw({
          source:vectorSourceDrawLine,
          type:'LineString'
        });
        drawLine.on('drawend',function(e){
      //移除之前的线要素
      var formatDrawLine=new ol.format.GeoJSON();
      featureDrawLine = formatDrawLine.writeFeature(e.feature.clone(),{
        dataProjection:'EPSG:4326',
        featureProjection:'EPSG:3857'
      });
      vectorSourceDrawLine.addFeature(e.feature);
      console.log(typeof(featureDrawLine));
      var featureDrawLineobject;
      eval("featureDrawLineobject="+featureDrawLine); 
      var length1=turf.lineDistance(featureDrawLineobject, 'miles');
      // var length1=turf.lineDistance(featureDrawLine, 'miles');
      alert("length1   "+length1*1609.344+"米");
      clearmeasure();             //移除绘制线和面的交互事件
      map.on('click',mapclick);//添加原先的鼠标点击事件
    });
        //向地图添加交互
        map.addInteraction(drawLine);
      }
}
function printmapfun(e)   //下载地图
{
    console.log("保存地图");
    canvas = document.getElementsByTagName('canvas')[0];
    canvas.toBlob(function (blob) {
      saveAs(blob, 'map.png');
    })
}
    </script>
</body>
</html>