<!DOCTYPE html>
<html>
  <head>
    <title>报修管理</title>
    <link rel="stylesheet" href="http://openlayers.org/en/v3.16.0/css/ol.css" type="text/css">
    <script src="http://openlayers.org/en/v3.16.0/build/ol.js"></script>


<!-- 新添加的工具库 -->
    <script src="assets/js/helpers.js"></script>
    <script type="text/javascript" src="js/echarts.js"></script>


     <link rel="stylesheet" type="text/css" href="font/titillium/stylesheet.css">
<link rel="stylesheet" type="text/css" href="font/exo-demibold/stylesheet.css">
<link rel="stylesheet" type="text/css" href="css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="css/resetpage1.css">
<link rel="stylesheet" type="text/css" href="css/animation.css">
<link rel="stylesheet" type="text/css" href="css/blue/responsive.css">
<link rel="stylesheet" type="text/css" href="css/blue/color.css">

<link rel="stylesheet" type="text/css" href="css/live-preview.css">
<link rel="stylesheet" type="text/css" href="live-font/stylesheet.css">
  <script src="assets/js/jquery-1.12.0.min.js"></script>

<script type="text/javascript" src="js/modernizr.custom.29473.js"></script>
<script type="text/javascript" src="js/dropdown.js"></script>
    <style>
           table{
          border:solid;
          border-color:#6E9AEA;
              position: relative;
              top:20px;
              left:20px;
              }
         tr td,th{
            /*border:solid #6E9AEA;*/
            width: 70px;
            height: 25px;
         }
        .td_Num
        {
            width: 40px;
            text-align: center;
        }
        .td_Item
        {
            width: 75px;
            text-align: center;
        }
        .td_Oper
        {
            width: 190px;
            text-align: center;
        }
        .td_Oper span
        {
            cursor: pointer;
        }
        .popstyle
        {
            margin: 50px;
            background-color: #f0f3f9;
            /*position:relative;*/
            z-index: 999;
            /*设置边框蓝光*/
            -moz-box-shadow:0 0 25px #697cf5;
            -webkit-box-shadow:0 0 25px #697cf5;
            box-shadow:0 0 25px #8cb9f5;
            /*设置圆角*/
            -moz-border-radius: 15px;      /* Gecko browsers */
            -webkit-border-radius: 15px;   /* Webkit browsers */
            border-radius:15px;            /* W3C syntax */
        }
#popdiv{
              width: 450px;
              height: 240px;
              overflow: auto;
              position:fixed;
              right:30px; 
              top:60px; 
            background-color: #f0f3f9;
}
#popdivbar{
            background-color: #f0f3f9;
             width:450px;
             height: 240px;
             /*overflow: auto;*/
             position:absolute;
             right:30px; 
             top:310px; 
}
      #map {
        position: relative;
      }
      #info {
        position: absolute;
        height: 1px;
        width: 1px;
        z-index: 100;
      }
      .tooltip.in {
        opacity: 1;
      }
      .tooltip.top .tooltip-arrow {
        border-top-color: white;
      }
      .tooltip-inner {
        border: 2px solid white;
      }
    </style>
  </head>
  <body>
  <ul class="nav" style="position:fixed;">
  
  <!-- Start Home -->
  <li id="first">
    <div id="cover1"><a href="3d/buildingsdemo.html">三维校园<i class="icon-chevron-down"></i></a></div>
    <div id="icon"><i class="icon-home" ></i></div>
     <ul class="one" id="home">
      <li>
          <h3><i class="icon-user"></i>Welcome</h3>
            <p id="p-first">中国地质大学（武汉）位于武汉东湖国家自主创新示范区腹地。学校拥有国家4A级旅游景区——逸夫博物馆，是全国文明单位、湖北省最佳文明单位。校园环境优美，教育、科研、学术氛围浓厚，拥有现代化的教学楼群、图书馆、学生公寓和近万台随时上网的计算机等相关配套设施，为莘莘学子提供了良好的学习、生活和成长的环境。</p>
            <!-- <img src="img/didalogo.png"> -->
            <a href="http://www.cug.edu.cn/new/">中国地质大学</a>
        </li>
     </ul>
  </li>
  
  <!-- Start Portfolio -->
  <li>
    <div id="cover1"><a href="clustertest.html" >报修管理<i class="icon-chevron-down"></i></a></div>
    <div id="icon"><i class="icon-briefcase" ></i></div>
  </li>
  
  <!-- Start Services -->
  <li>
    <div id="cover1"><a href="TSP.html">路径导航<i class="icon-chevron-down"></i></a></div>
    <div id="icon"><i class="icon-truck" ></i></div>
  </li>
 
  <li>
    <div id="cover1"><a href="heatmap.html">垃圾箱管理<i class="icon-chevron-down"></i></a></div>
    <div id="icon"><i class="icon-book" ></i></div>
    <ul class="one" id="about">
      <li><img src="img/thumb1.png" alt="image">
        <h3><i class="icon-user"></i>模型简介及参数说明</h3>
        <p>
        道路理论垃圾桶数量 =<br>（人均垃圾量*一天总的道路人流量）/（容量*清理次数）<br><br>
若理论数量>实际数量,增加垃圾桶数量或增加清理次数<br>若理论数量>实际数量,减少垃圾桶数量或保持现状<br><br>
您可以通过重新设定清理次数或垃圾桶个数来计算上述比值得出优化配置结果（增加几个，在哪个位置合适，垃圾桶数量过多会影响美观性,这时您可以考虑增加清理次数来代替增加数量）
        </p>
        <h6><i class="icon-quote-left"></i>垃圾也有用，请别乱扔它。<i class="icon-quote-right"></i></h6>
      </li>
    </ul>
  </li>
  
  <!-- Start Contact -->
  <li>
    <div id="cover1"><a href="joins-inside.html">失物招领<i class="icon-chevron-down"></i></a></div>
    <div id="icon"><i class="icon-envelope" ></i></div>
    <ul class="one" id="contact">
      <li id="part-right">
        <p>地点<em>*</em></p>
        <input name="name" type="text" id="name">
        <p>联系方式<em>*</em></p>
        <input name="email" type="text" id="email">
        <p>描述<em>*</em></p>
        <textarea name="comment" cols="" rows="" id="comment"></textarea>
        <p>请在地图上添加物品丢失的位置<em>*</em></p>
      </li>
    </ul>
  </li>
  
  <!-- Start Search -->
  <li id="search">
    <input name="search" type="text" placeholder="Search" id="txt_search2">
    <a href="#"><i class="icon-search"></i></a> 
  </li>
</ul>
    <div id="map" class="map"></div>
    <div id="popdiv" class="popstyle" style="display:none">
    <table>
        <tr>
            <td class='td_Num'>序号</td>
            <td class='td_Item'>地点</td>
            <td class='td_Item'>联系方式</td>
            <td class='td_Oper'>描述</td>
        </tr>
    </table>
    <table id="content"></table>
  </div>
    <div id="popdivbar" class="popstyle" style="display:none"></div>
    <script>
      var earthquakeFill = new ol.style.Fill({
        // color: 'rgba(255, 153, 0, 0.8)'
        color: 'rgba(255, 103, 0, 0.8)'
      });
      var earthquakeStroke = new ol.style.Stroke({
        color: 'rgba(255, 104, 0, 0.2)',
        // color: 'rgba(255, 204, 0, 0.2)',
        width: 1
      });
      var textFill = new ol.style.Fill({
        color: '#fff'
      });
      var textStroke = new ol.style.Stroke({
        color: 'rgba(0, 0, 0, 0.6)',
        width: 3
      });
      var invisibleFill = new ol.style.Fill({
        color: 'rgba(255, 255, 255, 0.01)'
      });

      function createEarthquakeStyle(feature) {
        var name = feature.get('FID');
        // var name = feature.get('name');
        // var magnitude = parseFloat(name.substr(2));
        var magnitude = parseFloat(name);
        // console.log(magnitude);
        var radius = 5 + 20 * (magnitude - 5);

        return new ol.style.Style({
          geometry: feature.getGeometry(),
          image: new ol.style.RegularShape({
            radius1: radius,
            radius2: 3,
            points: 5,
            angle: Math.PI,
            fill: earthquakeFill,
            stroke: earthquakeStroke
          })
        });
      }

      var maxFeatureCount, vector;
      function calculateClusterInfo(resolution) {
        maxFeatureCount = 0;
        var features = vector.getSource().getFeatures();
        var feature, radius;
        for (var i = features.length - 1; i >= 0; --i) {
          feature = features[i];
          var originalFeatures = feature.get('features');
          var extent = ol.extent.createEmpty();
          var j, jj;
          for (j = 0, jj = originalFeatures.length; j < jj; ++j) {
            ol.extent.extend(extent, originalFeatures[j].getGeometry().getExtent());
          }
          maxFeatureCount = Math.max(maxFeatureCount, jj);
          radius = 0.25 * (ol.extent.getWidth(extent) + ol.extent.getHeight(extent)) /
              resolution;
          feature.set('radius', radius);
        }
      }

      var currentResolution;
      function styleFunction(feature, resolution) {
        if (resolution != currentResolution) {
          calculateClusterInfo(resolution);
          currentResolution = resolution;
        }
        var style;
        var size = feature.get('features').length;
        if (size > 1) {
          style = new ol.style.Style({
            image: new ol.style.Circle({
              radius: feature.get('radius'),
              fill: new ol.style.Fill({
                color: [155, 153, 250, Math.min(0.8, 0.4 + (size / maxFeatureCount))]
                // color: [255, 153, 0, Math.min(0.8, 0.4 + (size / maxFeatureCount))]
              })
            }),
            text: new ol.style.Text({
              text: size.toString(),
              fill: textFill,
              stroke: textStroke
            })
          });
        } else {
          var originalFeature = feature.get('features')[0];
          style = createEarthquakeStyle(originalFeature);
        }
        return style;
      }

      function selectStyleFunction(feature) {
        var styles = [new ol.style.Style({
          image: new ol.style.Circle({
            radius: feature.get('radius'),
            fill: invisibleFill
          })
        })];
        var originalFeatures = feature.get('features');
        var originalFeature;
        for (var i = originalFeatures.length - 1; i >= 0; --i) {
          originalFeature = originalFeatures[i];
          styles.push(createEarthquakeStyle(originalFeature));
        }
        return styles;
      }

      vector = new ol.layer.Vector({
        source: new ol.source.Cluster({
          distance: 40,
          source: new ol.source.Vector({
            //用于图上显示的KML文件
            url: 'assets/data/pointclusterkml.kml',
            format: new ol.format.KML({
              extractStyles: false
            })
          })
        }),
        style: styleFunction
      });
      //用于报表显示的json文件  vectorSource
      var geojsonObject = {
        "type": "FeatureCollection",
        "features": [{
            "type": "Feature",
            "properties": {},
            "geometry": {
                "type": "Point",
                "coordinates": [114.39778640000009, 30.522237200000063]
            }
        }]
    };
        var vectorSource = new ol.source.Vector({
        features: (new ol.format.GeoJSON()).readFeatures(geojsonObject)
    });
      vectorSource.clear();

        var vectorLayer = new ol.layer.Vector({//从数据中读出的点图层
        source: vectorSource
      });
        // fetchJSON('assets/data/pointtest2.geojson')
        fetchJSON('data/json/losteventgeojson.geojson')
        .then(function(points_fc) {
        newfeatures = points_fc;
        vectorSource.addFeatures(geojsonToFeatures(points_fc, {
          featureProjection: 'EPSG:3857'
        }));
        console.log(newfeatures);
        resultfun();
        showbar();
      });
     
      var openStreetMapLayer = new ol.layer.Tile({
        source:new ol.source.OSM()
    });
      var map = new ol.Map({
        layers: [openStreetMapLayer, vector,vectorLayer],
        target: 'map',
        view: new ol.View({
          center: ol.proj.transform(
             [114.3983815703, 30.5256872217],
            'EPSG:4326',
            'EPSG:3857'
          ),
          zoom: 15
        })
      });

//弹出表格**********************************************************************
    var currentStep = 0;
    var max_line_num = 0;
    //添加新记录
    function add_line(el) {
        max_line_num = $("#content tr:last-child").children("td").html();
        if (max_line_num == null) {
            max_line_num = 1;
        }
        else {
            max_line_num = parseInt(max_line_num);
            max_line_num += 1;
        }
        $('#content').append(
        "<tr id='line" + max_line_num + "'>" +
            "<td class='td_Num'>" + max_line_num + "</td>" +
            "<td class='td_Item'><input type='text'  style='width:70px' class='stepName' value='" + el.U.location + "'></input></td>" +
            "<td class='td_Item'><input type='text' style='width:70px'  class='stepDescription' value='" + el.U.contactway + "'></td>" +
            "<td class='td_Oper'><input type='text' style='width:170px'  class='stepDescription' value='" + el.U.event + "'></td>" +
        "</tr>");
    }
    //删除选择记录
    function clearcontent()
    {
      $("#content tr").each(function () {
                $(this).remove(); 
            });
      max_line_num=0;
    }
    function remove_line(index) {
        if (index != null) {
            currentStep = $(index).parent().parent().find("td:first-child").html();
        }
        if (currentStep == 0) {
            alert('请选择一项!');
            return false;
        }
        if (confirm("确定要删除改记录吗？")) {
            $("#content tr").each(function () {
                var seq = parseInt($(this).children("td").html());
                if (seq == currentStep) { $(this).remove(); }
                if (seq > currentStep) { $(this).children("td").each(function (i) { if (i == 0) $(this).html(seq - 1); }); }
            });
        }
    }
    //上移
    function up_exchange_line(index) {
        if (index != null) {
            currentStep = $(index).parent().parent().find("td:first-child").html();
        }
        if (currentStep == 0) {
            alert('请选择一项!');
            return false;
        }
        if (currentStep <= 1) {
            alert('已经是最顶项了!');
            return false;
        }
        var upStep = currentStep - 1;
        //修改序号
        $('#line' + upStep + " td:first-child").html(currentStep);
        $('#line' + currentStep + " td:first-child").html(upStep);
        //取得两行的内容
        var upContent = $('#line' + upStep).html();
        var currentContent = $('#line' + currentStep).html();
        $('#line' + upStep).html(currentContent);
        //交换当前行与上一行内容
        $('#line' + currentStep).html(upContent);
        $('#content tr').each(function () { $(this).css("background-color", "#ffffff"); });
        $('#line' + upStep).css("background-color", "yellow");
        event.stopPropagation(); //阻止事件冒泡
    }
    //下移
    function down_exchange_line(index) {
        if (index != null) {
            currentStep = $(index).parent().parent().find("td:first-child").html();
        }
        if (currentStep == 0) {
            alert('请选择一项!');
            return false;
        }
        if (currentStep >= max_line_num) {
            alert('已经是最后一项了!');
            return false;
        }
        var nextStep = parseInt(currentStep) + 1;
        //修改序号
        $('#line' + nextStep + " td:first-child").html(currentStep);
        $('#line' + currentStep + " td:first-child").html(nextStep);
        //取得两行的内容
        var nextContent = $('#line' + nextStep).html();
        var currentContent = $('#line' + currentStep).html();
        //交换当前行与上一行内容
        $('#line' + nextStep).html(currentContent);
        $('#line' + currentStep).html(nextContent);
        $('#content tr').each(function () { $(this).css("background-color", "#ffffff"); });
        $('#line' + nextStep).css("background-color", "yellow");
        event.stopPropagation(); //阻止事件冒泡
    }
    //保存数据
    function SaveData() {
        var data = "<root>";
        $('#content tr').each(function () {
            data += "<item>";
            var stepName = $(this).find("td:eq(1)").find("input").val();
            var stepDescription = $(this).find("td:eq(2)").find("input").val();
            data += "   <stepName>" + stepName + "</stepName>";
            data += "   <stepDescription>" + stepDescription + "</stepDescription>";
            data += "<item>";
        });
        data += "</root>";
        alert(data);
    }
function resultfun(){
  console.log("查看全部报修数据");
   vectorSource.getFeatures().forEach(function(el) {
                  console.log(el);
                  document.getElementById('popdiv').style.display = 'block';
                  add_line(el);
            });
}
function showbar()
{
  document.getElementById('popdivbar').style.display = 'block';
   var dom = document.getElementById("popdivbar");
                var myChart = echarts.init(dom);
                var app = {};
                option = null;
                      var data ={
                            categories: ["教三楼","公主楼","西区篮球场","52,53栋","教一楼","数理楼"],
                            data: [15, 20, 3, 40, 10, 20]
                        }
                // 初始 option
                option = {
                    title: {
                        text: '报修信息统计'
                    },
                    tooltip: {},
                    legend: {
                        data:['报修数量']
                    },
                    xAxis: {
                        data: []
                    },
                    yAxis: {},
                    series: [{
                        name: '报修数量',
                        type: 'bar',
                        data: []
                    }]
                };
                function a(data) {
                console.log(data)
                    myChart.setOption({
                        xAxis: {
                            data: data.categories
                        },
                        series: [{
                            // 根据名字对应到相应的系列
                            name: '报修数量',
                            data: data.data
                        }]
                    });
                };
                myChart.setOption(option, true);
                a(data);
}

    </script>
  </body>
</html>